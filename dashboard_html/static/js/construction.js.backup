// ==========================================
// Construction Intelligence Dashboard
// ==========================================

let map = null;
let markers = null;
let allPermits = [];
let trendsChart = null;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    initializeMap();
    loadDashboardData();
    initializeNavigation();
});

// =========================
// MAP INITIALIZATION
// =========================

function initializeMap() {
    // Initialize Leaflet map centered on NYC
    map = L.map('constructionMap').setView([40.7128, -74.0060], 11);
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
    
    // Initialize marker cluster group
    markers = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    });
    
    map.addLayer(markers);
}

function loadMarkersOnMap(permits) {
    // Clear existing markers
    markers.clearLayers();
    
    // Add markers for permits with coordinates
    permits.forEach(permit => {
        if (permit.latitude && permit.longitude) {
            const marker = createPermitMarker(permit);
            markers.addLayer(marker);
        }
    });
}

function createPermitMarker(permit) {
    // Color by job type
    const colors = {
        'NB': '#ef4444',    // red - new building
        'A1': '#f59e0b',    // orange - major alteration
        'A2': '#eab308',    // yellow - minor alteration
        'A3': '#84cc16',    // lime - alteration
        'DM': '#6366f1',    // indigo - demolition
        'SG': '#8b5cf6',    // purple - sign
    };
    
    const color = colors[permit.job_type] || '#64748b';
    
    const icon = L.divIcon({
        className: 'custom-marker',
        html: `<div style="
            background: ${color};
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        "></div>`,
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });
    
    const marker = L.marker([permit.latitude, permit.longitude], { icon });
    
    // Create popup content
    const popupContent = `
        <div style="min-width: 250px;">
            <div style="font-weight: 700; font-size: 1rem; margin-bottom: 0.5rem; color: #1f2937;">
                ${permit.address}
            </div>
            <div style="background: ${color}; color: white; display: inline-block; padding: 0.25rem 0.75rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; margin-bottom: 0.5rem;">
                ${permit.job_type} - ${getJobTypeName(permit.job_type)}
            </div>
            <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
                <div style="margin-bottom: 0.25rem;">
                    <strong>Applicant:</strong> ${permit.applicant || 'Unknown'}
                </div>
                <div style="margin-bottom: 0.25rem;">
                    <strong>Issue Date:</strong> ${formatDate(permit.issue_date)}
                </div>
                ${permit.estimated_job_cost ? `
                    <div style="margin-bottom: 0.25rem;">
                        <strong>Est. Cost:</strong> $${formatNumber(permit.estimated_job_cost)}
                    </div>
                ` : ''}
                ${permit.contact_count > 0 ? `
                    <div style="margin-bottom: 0.25rem;">
                        <strong>Contacts:</strong> ${permit.contact_count}
                    </div>
                ` : ''}
            </div>
            <a href="/property/${permit.bbl}" style="display: inline-block; background: #8b5cf6; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; text-decoration: none; font-size: 0.875rem; font-weight: 600; margin-top: 0.75rem;">
                View Full Details ‚Üí
            </a>
        </div>
    `;
    
    marker.bindPopup(popupContent);
    
    return marker;
}

function getJobTypeName(code) {
    const names = {
        'NB': 'New Building',
        'A1': 'Major Alteration',
        'A2': 'Minor Alteration',
        'A3': 'Alt w/o Permit',
        'DM': 'Demolition',
        'SG': 'Sign'
    };
    return names[code] || code;
}

// =========================
// DATA LOADING
// =========================

async function loadDashboardData() {
    Loading.showPage('Loading construction data...');
    
    try {
        // Load all data in parallel
        const [statsRes, permitsRes, contractorsRes, typesRes, boroughsRes, trendsRes] = await Promise.all([
            fetch('/api/construction/stats'),
            fetch('/api/construction/permits?days=90'),
            fetch('/api/construction/contractors?days=365&limit=20'),
            fetch('/api/construction/by-type'),
            fetch('/api/construction/by-borough'),
            fetch('/api/construction/trends?days=180')
        ]);
        
        const stats = await statsRes.json();
        const permitsData = await permitsRes.json();
        const contractorsData = await contractorsRes.json();
        const typesData = await typesRes.json();
        const boroughsData = await boroughsRes.json();
        const trendsData = await trendsRes.json();
        
        // Store permits
        allPermits = permitsData.permits || [];
        
        // Populate dashboard
        populateStats(stats);
        loadMarkersOnMap(allPermits);
        populatePermitsList(allPermits);
        populateContractors(contractorsData.contractors || []);
        populateTypes(typesData.types || []);
        populateBoroughs(boroughsData.boroughs || []);
        populateTrends(trendsData.trends || []);
        populateQuickStats(stats, permitsData);
        
        Loading.hidePage();
    } catch (error) {
        console.error('Error loading dashboard:', error);
        Loading.hidePage();
        alert('Error loading construction data. Please refresh the page.');
    }
}

function populateStats(data) {
    document.getElementById('statActivePermits').textContent = formatNumber(data.total_permits || 0);
    
    const value = data.total_value || 0;
    document.getElementById('statTotalValue').textContent = value > 0 ? 
        '$' + (value / 1000000).toFixed(1) + 'M' : 
        '$0';
    
    document.getElementById('statTopBorough').textContent = data.top_borough || 'N/A';
    document.getElementById('statTrendingType').textContent = data.trending_type || 'N/A';
}

function populateQuickStats(stats, permits) {
    const container = document.getElementById('quickStats');
    
    const recent = permits.permits?.filter(p => {
        const issueDate = new Date(p.issue_date);
        const daysAgo = (new Date() - issueDate) / (1000 * 60 * 60 * 24);
        return daysAgo <= 7;
    }).length || 0;
    
    const withContacts = permits.permits?.filter(p => p.contact_count > 0).length || 0;
    
    const newBuildings = permits.permits?.filter(p => p.job_type === 'NB').length || 0;
    
    const highValue = permits.permits?.filter(p => 
        p.estimated_job_cost && parseFloat(p.estimated_job_cost) > 1000000
    ).length || 0;
    
    container.innerHTML = `
        <div class="quick-stat">
            <div class="quick-stat-icon">üÜï</div>
            <div class="quick-stat-content">
                <div class="quick-stat-value">${formatNumber(recent)}</div>
                <div class="quick-stat-label">This Week</div>
            </div>
        </div>
        
        <div class="quick-stat">
            <div class="quick-stat-icon">üìû</div>
            <div class="quick-stat-content">
                <div class="quick-stat-value">${formatNumber(withContacts)}</div>
                <div class="quick-stat-label">With Contacts</div>
            </div>
        </div>
        
        <div class="quick-stat">
            <div class="quick-stat-icon">üè¢</div>
            <div class="quick-stat-content">
                <div class="quick-stat-value">${formatNumber(newBuildings)}</div>
                <div class="quick-stat-label">New Buildings</div>
            </div>
        </div>
        
        <div class="quick-stat">
            <div class="quick-stat-icon">üíé</div>
            <div class="quick-stat-content">
                <div class="quick-stat-value">${formatNumber(highValue)}</div>
                <div class="quick-stat-label">High Value ($1M+)</div>
            </div>
        </div>
    `;
}

// =========================
// PERMITS LIST TAB
// =========================

function populatePermitsList(permits) {
    const container = document.getElementById('permitsList');
    const countEl = document.getElementById('permitsListCount');
    
    if (permits.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-clipboard-list"></i><p>No permits found</p></div>';
        countEl.textContent = '0 permits';
        return;
    }
    
    countEl.textContent = `${formatNumber(permits.length)} permit${permits.length !== 1 ? 's' : ''}`;
    
    container.innerHTML = permits.map(permit => {
        const typeClass = `type-${permit.job_type.toLowerCase()}`;
        
        return `
            <div class="permit-card" onclick="window.location.href='/property/${permit.bbl}'">
                <div class="permit-header">
                    <div style="flex: 1;">
                        <div class="permit-title">${permit.address || 'Address Not Available'}</div>
                        <div class="permit-address">
                            ${permit.borough ? permit.borough + ' ¬∑ ' : ''}
                            BBL: ${permit.bbl || 'N/A'}
                        </div>
                    </div>
                    <div class="permit-type-badge ${typeClass}">
                        ${permit.job_type}
                    </div>
                </div>
                
                <div class="permit-details">
                    <div class="permit-detail-item">
                        <div class="permit-detail-label">Applicant</div>
                        <div class="permit-detail-value">${permit.applicant || 'Unknown'}</div>
                    </div>
                    <div class="permit-detail-item">
                        <div class="permit-detail-label">Issue Date</div>
                        <div class="permit-detail-value">${formatDate(permit.issue_date)}</div>
                    </div>
                    <div class="permit-detail-item">
                        <div class="permit-detail-label">Status</div>
                        <div class="permit-detail-value">${permit.permit_status || 'Active'}</div>
                    </div>
                    ${permit.stories ? `
                        <div class="permit-detail-item">
                            <div class="permit-detail-label">Stories</div>
                            <div class="permit-detail-value">${permit.stories}</div>
                        </div>
                    ` : ''}
                    ${permit.total_units ? `
                        <div class="permit-detail-item">
                            <div class="permit-detail-label">Units</div>
                            <div class="permit-detail-value">${permit.total_units}</div>
                        </div>
                    ` : ''}
                    ${permit.contact_count > 0 ? `
                        <div class="permit-detail-item">
                            <div class="permit-detail-label">Contacts</div>
                            <div class="permit-detail-value">
                                <i class="fas fa-phone" style="color: var(--primary);"></i> ${permit.contact_count}
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

function sortPermitsList() {
    const sortBy = document.getElementById('sortBy').value;
    let sorted = [...allPermits];
    
    switch(sortBy) {
        case 'date_desc':
            sorted.sort((a, b) => new Date(b.issue_date) - new Date(a.issue_date));
            break;
        case 'date_asc':
            sorted.sort((a, b) => new Date(a.issue_date) - new Date(b.issue_date));
            break;
        case 'address':
            sorted.sort((a, b) => (a.address || '').localeCompare(b.address || ''));
            break;
        case 'applicant':
            sorted.sort((a, b) => (a.applicant || '').localeCompare(b.applicant || ''));
            break;
        case 'type':
            sorted.sort((a, b) => (a.job_type || '').localeCompare(b.job_type || ''));
            break;
    }
    
    populatePermitsList(sorted);
}

// =========================
// CONTRACTORS TAB
// =========================

function populateContractors(contractors) {
    const container = document.getElementById('contractorsList');
    
    if (contractors.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>No contractors found</p></div>';
        return;
    }
    
    container.innerHTML = contractors.map((contractor, index) => `
        <div class="contractor-card">
            <div style="display: flex; align-items: start; gap: var(--spacing-md);">
                <span class="contractor-rank">${index + 1}</span>
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 1rem; color: var(--text-primary); margin-bottom: var(--spacing-sm);">
                        ${contractor.applicant}
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-lg); font-size: 0.875rem; color: var(--text-secondary);">
                        <div>
                            <i class="fas fa-file-alt"></i>
                            <strong>${formatNumber(contractor.permit_count)}</strong> permits
                        </div>
                        <div>
                            <i class="fas fa-map-marker-alt"></i>
                            <strong>${contractor.boroughs_count}</strong> borough${contractor.boroughs_count !== 1 ? 's' : ''}
                        </div>
                        ${contractor.total_value ? `
                            <div>
                                <i class="fas fa-dollar-sign"></i>
                                <strong>$${(contractor.total_value / 1000000).toFixed(1)}M</strong>
                            </div>
                        ` : ''}
                    </div>
                    ${contractor.job_types ? `
                        <div style="margin-top: var(--spacing-sm); font-size: 0.75rem; color: var(--text-muted);">
                            <strong>Types:</strong> ${contractor.job_types}
                        </div>
                    ` : ''}
                    <div style="margin-top: var(--spacing-sm); font-size: 0.75rem; color: var(--text-muted);">
                        Last permit: ${formatDate(contractor.last_permit_date)}
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// =========================
// TRENDS TAB
// =========================

function populateTrends(trends) {
    if (trends.length === 0) return;
    
    const ctx = document.getElementById('trendsChart');
    
    // Destroy existing chart
    if (trendsChart) {
        trendsChart.destroy();
    }
    
    // Prepare data
    const labels = trends.map(t => formatDate(t.week));
    const data = trends.map(t => t.count);
    
    trendsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Permits Issued',
                data: data,
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#9ca3af'
                    },
                    grid: {
                        color: '#374151'
                    }
                },
                x: {
                    ticks: {
                        color: '#9ca3af',
                        maxRotation: 45,
                        minRotation: 45
                    },
                    grid: {
                        color: '#374151'
                    }
                }
            }
        }
    });
}

// =========================
// TYPES TAB
// =========================

function populateTypes(types) {
    const container = document.getElementById('typesChart');
    
    if (types.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-th-list"></i><p>No data found</p></div>';
        return;
    }
    
    const maxCount = Math.max(...types.map(t => t.count));
    
    container.innerHTML = types.map(type => {
        const percentage = (type.count / maxCount) * 100;
        return `
            <div class="chart-bar">
                <div class="chart-label">${type.job_type}</div>
                <div class="chart-bar-container">
                    <div class="chart-bar-fill" style="width: ${percentage}%">
                        <span class="chart-value">${formatNumber(type.count)}</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// =========================
// BOROUGHS TAB
// =========================

function populateBoroughs(boroughs) {
    const container = document.getElementById('boroughsChart');
    
    if (boroughs.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-map"></i><p>No data found</p></div>';
        return;
    }
    
    const maxCount = Math.max(...boroughs.map(b => b.count));
    
    container.innerHTML = boroughs.map(borough => {
        const percentage = (borough.count / maxCount) * 100;
        return `
            <div class="chart-bar">
                <div class="chart-label">${borough.borough}</div>
                <div class="chart-bar-container">
                    <div class="chart-bar-fill" style="width: ${percentage}%">
                        <span class="chart-value">${formatNumber(borough.count)}</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// =========================
// FILTERS
// =========================

async function applyFilters() {
    const borough = document.getElementById('filterBorough').value;
    const jobType = document.getElementById('filterJobType').value;
    const days = document.getElementById('filterDays').value;
    
    Loading.showPage('Applying filters...');
    
    try {
        const params = new URLSearchParams();
        if (borough) params.append('borough', borough);
        if (jobType) params.append('job_type', jobType);
        params.append('days', days);
        
        const response = await fetch(`/api/construction/permits?${params}`);
        const data = await response.json();
        
        allPermits = data.permits || [];
        loadMarkersOnMap(allPermits);
        populatePermitsList(allPermits);
        
        Loading.hidePage();
    } catch (error) {
        console.error('Error applying filters:', error);
        Loading.hidePage();
        alert('Error applying filters. Please try again.');
    }
}

function clearFilters() {
    document.getElementById('filterBorough').value = '';
    document.getElementById('filterJobType').value = '';
    document.getElementById('filterDays').value = '90';
    applyFilters();
}

// =========================
// TAB MANAGEMENT
// =========================

function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.closest('.tab-btn').classList.add('active');
    
    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(tabName + 'Tab').classList.add('active');
}

// =========================
// NAVIGATION
// =========================

function initializeNavigation() {
    const savedListsBtn = document.getElementById('savedListsBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    
    if (savedListsBtn) {
        savedListsBtn.addEventListener('click', () => {
            alert('Saved Lists feature coming soon!');
        });
    }
    
    if (settingsBtn) {
        settingsBtn.addEventListener('click', () => {
            alert('Settings feature coming soon!');
        });
    }
}

// =========================
// UTILITY FUNCTIONS
// =========================

function formatNumber(num) {
    if (!num) return '0';
    return Math.round(num).toLocaleString();
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

function formatCurrency(amount) {
    if (!amount) return '$0';
    return '$' + Math.round(amount).toLocaleString();
}

// Export for global access
window.Construction = {
    applyFilters,
    clearFilters,
    switchTab
};
