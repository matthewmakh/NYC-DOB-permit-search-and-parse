<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOB Permit Leads Dashboard</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>üîç Filters</h1>
            </div>

            <!-- Quick Date Filters -->
            <div class="filter-section">
                <h3>‚ö° Quick Date Filters</h3>
                <select id="dateFilter" class="filter-select">
                    <option value="custom">Custom</option>
                    <option value="24h">Last 24 Hours</option>
                    <option value="week">Last Week</option>
                    <option value="month">Last Month</option>
                    <option value="quarter">Last Quarter</option>
                    <option value="6months">Last 6 Months</option>
                    <option value="year">Last Year</option>
                    <option value="all" selected>All Time</option>
                </select>

                <div id="customDateRange" class="custom-date-range" style="display: none;">
                    <input type="date" id="dateFrom" class="filter-input">
                    <input type="date" id="dateTo" class="filter-input">
                </div>
            </div>

            <!-- Smart Filters -->
            <div class="filter-section">
                <h3>üéØ Smart Filters</h3>
                <div class="smart-filters-grid">
                    <button class="smart-filter-btn" data-filter="small_nb">
                        üè¢ Small New Buildings<br><small>(&lt;30 units)</small>
                    </button>
                    <button class="smart-filter-btn" data-filter="multifamily_alt">
                        üèòÔ∏è Multi-Family<br><small>Renovations</small>
                    </button>
                    <button class="smart-filter-btn" data-filter="large">
                        üìê Large Projects<br><small>(50+ units)</small>
                    </button>
                    <button class="smart-filter-btn" data-filter="single_family">
                        üè† Single-Family<br><small>Homes</small>
                    </button>
                    <button class="smart-filter-btn" data-filter="demo">
                        üí• Active Demo<br><small>Sites</small>
                    </button>
                    <button class="smart-filter-btn" data-filter="recent">
                        üÜï Recently Issued<br><small>(30 days)</small>
                    </button>
                    <button class="smart-filter-btn" data-filter="expiring_soon">
                        ‚è∞ Expiring Soon<br><small>(30 days)</small>
                    </button>
                    <button class="smart-filter-btn active" data-filter="all">
                        üìã Show All
                    </button>
                </div>
            </div>

            <!-- Contact Search -->
            <div class="filter-section">
                <h3>üîç Search by Contact</h3>
                <input type="text" id="contactSearch" class="filter-input" placeholder="e.g., John Smith" minlength="2">
                <div id="contactSearchResults" class="search-results"></div>
            </div>

            <!-- Manual Filters -->
            <div class="filter-section">
                <h3>Manual Filters</h3>
                
                <label class="checkbox-label">
                    <input type="checkbox" id="hasContacts" checked>
                    Only show leads with phone numbers
                </label>

                <label class="checkbox-label">
                    <input type="checkbox" id="mobileOnly">
                    üì± Mobile numbers only
                </label>

                <div class="slider-group">
                    <label>Minimum contacts: <span id="minContactsValue">0</span></label>
                    <input type="range" id="minContacts" min="0" max="5" value="0" class="slider">
                </div>

                <div class="slider-group">
                    <label>Minimum lead score: <span id="minScoreValue">0</span></label>
                    <input type="range" id="minScore" min="0" max="100" step="5" value="0" class="slider">
                </div>

                <div class="filter-group">
                    <label>Permit Status</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="permitStatus" value="Active" checked>
                            Active
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="permitStatus" value="Expired" checked>
                            Expired
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="permitStatus" value="Expiring Soon" checked>
                            Expiring Soon
                        </label>
                    </div>
                </div>

                <div class="filter-group">
                    <label>Permit Type</label>
                    <select id="permitType" class="filter-select">
                        <option value="all">All</option>
                        <!-- Will be populated dynamically -->
                    </select>
                </div>

                <div class="slider-group">
                    <label>Total Units: <span id="unitsRangeValue">All</span></label>
                    <input type="range" id="unitsRange" min="0" max="500" value="500" class="slider">
                </div>

                <div class="slider-group">
                    <label>Building Stories: <span id="storiesRangeValue">All</span></label>
                    <input type="range" id="storiesRange" min="0" max="100" value="100" class="slider">
                </div>
            </div>

            <!-- Actions -->
            <div class="filter-section">
                <h3>Actions</h3>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="refreshBtn">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                    <button class="btn btn-secondary" id="clearBtn">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <h1>üìã DOB Permit Leads Dashboard</h1>
            </header>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="leads">üèóÔ∏è Permit View</button>
                <button class="tab-btn" data-tab="buildings">üè¢ Building View</button>
                <button class="tab-btn" data-tab="sellers">üí∞ Seller Leads</button>
                <button class="tab-btn" data-tab="visualizations">üìà Visualizations</button>
                <button class="tab-btn" data-tab="map">üó∫Ô∏è Map View</button>
            </div>

            <!-- Tab Content -->
            <div class="tab-content active" id="leadsTab">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Leads</div>
                        <div class="stat-value" id="totalLeads">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Contacts</div>
                        <div class="stat-value" id="totalContacts">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üè¢ Buildings</div>
                        <div class="stat-value" id="totalBuildings">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">‚úÖ Enrichment Rate</div>
                        <div class="stat-value" id="enrichmentRate">0%</div>
                    </div>
                    <div class="stat-card hot">
                        <div class="stat-label">üî• Hot Leads</div>
                        <div class="stat-value" id="hotLeads">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üì± Mobile #s</div>
                        <div class="stat-value" id="mobileCount">0</div>
                    </div>
                </div>

                <!-- Search Bar -->
                <div class="search-bar">
                    <input type="text" id="globalSearch" placeholder="üîç Search by Address, Applicant, or Permit #">
                    <i class="fas fa-search"></i>
                </div>

                <!-- Results Header -->
                <div class="results-header">
                    <h2>Showing <span id="resultsCount">0</span> Leads</h2>
                    <div class="results-per-page">
                        <label>Results per page:</label>
                        <select id="resultsPerPage">
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100" selected>100</option>
                            <option value="250">250</option>
                            <option value="500">500</option>
                        </select>
                    </div>
                </div>

                <!-- Leads Cards -->
                <div id="leadsContainer" class="leads-container">
                    <!-- Will be populated dynamically -->
                </div>

                <!-- Pagination -->
                <div class="pagination" id="pagination">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <div class="tab-content" id="buildingsTab">
                <!-- Building View Dashboard -->
                <div class="building-stats-row">
                    <div class="building-stat-card primary">
                        <div class="stat-icon">üè¢</div>
                        <div class="stat-content">
                            <div class="stat-number" id="buildingsTotal">0</div>
                            <div class="stat-description">Total Buildings</div>
                        </div>
                    </div>
                    <div class="building-stat-card success">
                        <div class="stat-icon">üë§</div>
                        <div class="stat-content">
                            <div class="stat-number" id="buildingsWithOwners">0</div>
                            <div class="stat-description">With Owner Data</div>
                        </div>
                    </div>
                    <div class="building-stat-card info">
                        <div class="stat-icon">üìã</div>
                        <div class="stat-content">
                            <div class="stat-number" id="buildingsWithAcris">0</div>
                            <div class="stat-description">With Purchase History</div>
                        </div>
                    </div>
                    <div class="building-stat-card warning">
                        <div class="stat-icon">üìç</div>
                        <div class="stat-content">
                            <div class="stat-number" id="permitsWithBbl">0</div>
                            <div class="stat-description">Permits with BBL</div>
                        </div>
                    </div>
                </div>

                <!-- Owner Directory Header -->
                <div class="section-header">
                    <h2>üè¢ Building Portfolio</h2>
                    <div class="view-toggles">
                        <button class="view-toggle-btn active" data-view="cards">
                            <i class="fas fa-th-large"></i> Cards
                        </button>
                        <button class="view-toggle-btn" data-view="table">
                            <i class="fas fa-table"></i> Table
                        </button>
                    </div>
                </div>

                <!-- Buildings Container -->
                <div id="buildingsContainer" class="buildings-container">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Seller Leads Tab -->
            <div class="tab-content" id="sellersTab">
                <!-- Header -->
                <div class="seller-leads-header">
                    <h2>üí∞ Previous Owners Campaign - Seller Leads</h2>
                    <p class="section-description">
                        Property owners who have sold buildings in NYC - potential leads for new investment opportunities. 
                        Includes mailing addresses and C/O contacts (lawyers, agents, managers).
                    </p>
                </div>

                <!-- Stats Row -->
                <div class="stats-row" style="margin-bottom: 20px;">
                    <div class="building-stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-content">
                            <div class="stat-label">Total Sellers</div>
                            <div class="stat-value" id="totalSellers">0</div>
                        </div>
                    </div>
                    <div class="building-stat-card">
                        <div class="stat-icon">üè¢</div>
                        <div class="stat-content">
                            <div class="stat-label">Properties Sold</div>
                            <div class="stat-value" id="propertiesSold">0</div>
                        </div>
                    </div>
                    <div class="building-stat-card">
                        <div class="stat-icon">üîÅ</div>
                        <div class="stat-content">
                            <div class="stat-label">Repeat Sellers</div>
                            <div class="stat-value" id="repeatSellers">0</div>
                        </div>
                    </div>
                    <div class="building-stat-card">
                        <div class="stat-icon">üìß</div>
                        <div class="stat-content">
                            <div class="stat-label">C/O Contacts</div>
                            <div class="stat-value" id="careOfContacts">0</div>
                        </div>
                    </div>
                </div>

                <!-- Filters Row -->
                <div class="seller-filters-row">
                    <div class="filter-group">
                        <label for="stateFilter">State:</label>
                        <select id="stateFilter" class="filter-select">
                            <option value="">All States</option>
                            <option value="NY">New York</option>
                            <option value="NJ">New Jersey</option>
                            <option value="CT">Connecticut</option>
                            <option value="PA">Pennsylvania</option>
                            <option value="FL">Florida</option>
                            <option value="CA">California</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="priceFilter">Min Sale Price:</label>
                        <select id="priceFilter" class="filter-select">
                            <option value="0">All Prices</option>
                            <option value="500000">$500K+</option>
                            <option value="1000000">$1M+</option>
                            <option value="2000000">$2M+</option>
                            <option value="5000000">$5M+</option>
                            <option value="10000000">$10M+</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="repeatOnlyFilter">
                            Repeat Sellers Only
                        </label>
                    </div>
                    <div class="filter-group" style="margin-left: auto;">
                        <button id="refreshSellerLeads" class="btn btn-secondary">
                            üîÑ Refresh
                        </button>
                        <button id="exportSellerCSV" class="btn btn-primary">
                            üì• Export CSV
                        </button>
                    </div>
                </div>

                <!-- Table Container -->
                <div class="table-container">
                    <table class="seller-leads-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-column="seller_name">Seller Name</th>
                                <th>Mailing Address</th>
                                <th>C/O Contact</th>
                                <th>Property Sold</th>
                                <th class="sortable" data-column="sale_date">Sale Date</th>
                                <th class="sortable" data-column="sale_price">Sale Price</th>
                                <th class="sortable" data-column="properties_sold_count">Properties</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sellerLeadsBody">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>

                <!-- Loading State -->
                <div id="sellerLoadingState" class="loading-state" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading seller leads...</p>
                </div>

                <!-- No Results Message -->
                <div id="sellerNoResults" class="no-results" style="display: none;">
                    <p>No seller leads found matching your filters.</p>
                </div>
            </div>

            <div class="tab-content" id="visualizationsTab">
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>üìä Permits by Job Type</h3>
                        <canvas id="jobTypeChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>üë§ Top Property Owners</h3>
                        <canvas id="ownersChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>üèóÔ∏è Building Age Distribution</h3>
                        <canvas id="buildingAgeChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>üìè Unit Size Distribution</h3>
                        <canvas id="unitDistChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>üìÖ Permit Trends Over Time</h3>
                        <canvas id="trendsChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>üè¢ Top 10 Applicants</h3>
                        <canvas id="applicantsChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>üèóÔ∏è Building Stories Distribution</h3>
                        <canvas id="storiesChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="mapTab">
                <div class="map-controls">
                    <button class="btn btn-primary" id="loadMapBtn">üó∫Ô∏è Load Interactive Map</button>
                </div>
                <div id="map" class="map-container"></div>
            </div>

            <footer class="footer">
                <p>Last updated: <span id="lastUpdated"></span></p>
            </footer>
        </main>
    </div>

    <!-- Loading Overlay with Skeleton -->
    <div id="loadingOverlay">
        <div class="skeleton-container">
            <!-- Skeleton Sidebar -->
            <div class="skeleton-sidebar">
                <div class="skeleton skeleton-header"></div>
                
                <div class="skeleton-section">
                    <div class="skeleton skeleton-text short"></div>
                    <div class="skeleton skeleton-input"></div>
                </div>
                
                <div class="skeleton-section">
                    <div class="skeleton skeleton-text short"></div>
                    <div class="skeleton skeleton-button"></div>
                    <div class="skeleton skeleton-button"></div>
                    <div class="skeleton skeleton-button"></div>
                    <div class="skeleton skeleton-button"></div>
                </div>
                
                <div class="skeleton-section">
                    <div class="skeleton skeleton-text short"></div>
                    <div class="skeleton skeleton-input"></div>
                </div>
                
                <div class="skeleton-section">
                    <div class="skeleton skeleton-text short"></div>
                    <div class="skeleton skeleton-input"></div>
                    <div class="skeleton skeleton-input"></div>
                </div>
            </div>
            
            <!-- Skeleton Main Content -->
            <div class="skeleton-main">
                <!-- Skeleton Stats -->
                <div class="skeleton-stats-grid">
                    <div class="skeleton-stat-card">
                        <div class="skeleton skeleton-stat-title"></div>
                        <div class="skeleton skeleton-stat-value"></div>
                    </div>
                    <div class="skeleton-stat-card">
                        <div class="skeleton skeleton-stat-title"></div>
                        <div class="skeleton skeleton-stat-value"></div>
                    </div>
                    <div class="skeleton-stat-card">
                        <div class="skeleton skeleton-stat-title"></div>
                        <div class="skeleton skeleton-stat-value"></div>
                    </div>
                    <div class="skeleton-stat-card">
                        <div class="skeleton skeleton-stat-title"></div>
                        <div class="skeleton skeleton-stat-value"></div>
                    </div>
                </div>
                
                <!-- Skeleton Tabs -->
                <div class="skeleton-tabs">
                    <div class="skeleton skeleton-tab"></div>
                    <div class="skeleton skeleton-tab"></div>
                    <div class="skeleton skeleton-tab"></div>
                </div>
                
                <!-- Skeleton Cards -->
                <div class="skeleton-card">
                    <div class="skeleton skeleton-card-header"></div>
                    <div class="skeleton-card-content">
                        <div class="skeleton skeleton-card-line"></div>
                        <div class="skeleton skeleton-card-line"></div>
                        <div class="skeleton skeleton-card-line"></div>
                    </div>
                </div>
                
                <div class="skeleton-card">
                    <div class="skeleton skeleton-card-header"></div>
                    <div class="skeleton-card-content">
                        <div class="skeleton skeleton-card-line"></div>
                        <div class="skeleton skeleton-card-line"></div>
                        <div class="skeleton skeleton-card-line"></div>
                    </div>
                </div>
                
                <div class="skeleton-card">
                    <div class="skeleton skeleton-card-header"></div>
                    <div class="skeleton-card-content">
                        <div class="skeleton skeleton-card-line"></div>
                        <div class="skeleton skeleton-card-line"></div>
                        <div class="skeleton skeleton-card-line"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Building Detail Modal -->
    <div id="buildingDetailModal" class="modal">
        <div class="modal-content building-detail-modal">
            <div class="modal-header">
                <div class="modal-title">
                    <h2 id="buildingDetailAddress">Building Details</h2>
                    <div class="building-meta">
                        <span class="bbl-badge" id="buildingDetailBBL"></span>
                        <span class="owner-badge" id="buildingDetailOwner"></span>
                    </div>
                </div>
                <button class="modal-close" onclick="closeBuildingDetail()">&times;</button>
            </div>

            <div class="modal-body">
                <!-- Overview Section -->
                <div class="detail-section">
                    <h3>üè¢ Property Overview</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Building Type</span>
                            <span class="detail-value" id="buildingClass">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Land Use</span>
                            <span class="detail-value" id="landUse">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Year Built</span>
                            <span class="detail-value" id="yearBuilt">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Year Altered</span>
                            <span class="detail-value" id="yearAltered">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Units (Residential)</span>
                            <span class="detail-value" id="residentialUnits">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Total Units</span>
                            <span class="detail-value" id="totalUnits">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Number of Floors</span>
                            <span class="detail-value" id="numFloors">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Building Sq Ft</span>
                            <span class="detail-value" id="buildingSqft">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Lot Sq Ft</span>
                            <span class="detail-value" id="lotSqft">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ZIP Code</span>
                            <span class="detail-value" id="zipCode">-</span>
                        </div>
                    </div>
                </div>

                <!-- Owner Information Section -->
                <div class="detail-section">
                    <h3>üë§ Ownership Information</h3>
                    <div class="owner-sources">
                        <div class="owner-source-card" id="plutoOwner">
                            <div class="source-badge pluto">PLUTO</div>
                            <div class="owner-name" id="plutoOwnerName">-</div>
                        </div>
                        <div class="owner-source-card" id="rpadOwner">
                            <div class="source-badge rpad">RPAD</div>
                            <div class="owner-name" id="rpadOwnerName">-</div>
                        </div>
                        <div class="owner-source-card" id="hpdOwner">
                            <div class="source-badge hpd">HPD</div>
                            <div class="owner-name" id="hpdOwnerName">-</div>
                            <div class="owner-detail" id="hpdRegistration"></div>
                        </div>
                    </div>
                </div>

                <!-- Financial Information -->
                <div class="detail-section">
                    <h3>üí∞ Financial Information</h3>
                    <div class="financial-grid">
                        <div class="financial-card">
                            <div class="financial-label">Assessed Land Value</div>
                            <div class="financial-value" id="assessedLand">-</div>
                        </div>
                        <div class="financial-card">
                            <div class="financial-label">Assessed Total Value</div>
                            <div class="financial-value" id="assessedTotal">-</div>
                        </div>
                        <div class="financial-card" id="acrisCard">
                            <div class="financial-label">Last Sale Price</div>
                            <div class="financial-value" id="lastSalePrice">-</div>
                            <div class="financial-date" id="lastSaleDate"></div>
                        </div>
                    </div>
                </div>

                <!-- Quality Indicators -->
                <div class="detail-section" id="qualitySection">
                    <h3>‚ö†Ô∏è Quality Indicators</h3>
                    <div class="quality-grid">
                        <div class="quality-card violations">
                            <div class="quality-icon">üö®</div>
                            <div class="quality-content">
                                <div class="quality-number" id="violationsOpen">0</div>
                                <div class="quality-label">Open Violations</div>
                                <div class="quality-detail" id="violationsTotal">0 total</div>
                            </div>
                        </div>
                        <div class="quality-card complaints">
                            <div class="quality-icon">üìû</div>
                            <div class="quality-content">
                                <div class="quality-number" id="complaintsOpen">0</div>
                                <div class="quality-label">Open Complaints</div>
                                <div class="quality-detail" id="complaintsTotal">0 total</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Map Section -->
                <div class="detail-section">
                    <h3>üìç Location</h3>
                    <div id="buildingMap" class="building-map"></div>
                    <div class="coordinates-info" id="coordinatesInfo"></div>
                </div>

                <!-- Connected Permits -->
                <div class="detail-section">
                    <h3>üìã Connected Permits (<span id="permitCount">0</span>)</h3>
                    <div id="connectedPermits" class="connected-permits">
                        <!-- Permits will be loaded dynamically -->
                    </div>
                </div>

                <!-- All Contacts -->
                <div class="detail-section">
                    <h3>üìû All Contacts (<span id="contactCount">0</span>)</h3>
                    <div id="allContacts" class="all-contacts">
                        <!-- Contacts will be loaded dynamically -->
                    </div>
                </div>

                <!-- Nearby Buildings -->
                <div class="detail-section" id="nearbySection">
                    <h3>üèòÔ∏è Nearby Buildings in System</h3>
                    <div id="nearbyBuildings" class="nearby-buildings">
                        <!-- Nearby buildings will be loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
</body>
</html>

