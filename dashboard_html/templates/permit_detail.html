<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ permit.address or 'Permit Details' }} - DOB Permit</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: #0a0e1a; color: #e2e8f0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; padding: 1.5rem; }
        
        /* Back Button */
        .btn-back { 
            display: inline-flex; align-items: center; gap: 0.5rem; 
            padding: 0.5rem 1rem; background: #1e293b; border: 1px solid #334155; 
            border-radius: 8px; color: #94a3b8; text-decoration: none; 
            font-size: 0.875rem; transition: all 0.2s; margin-bottom: 1.5rem; 
        }
        .btn-back:hover { background: #334155; color: #fff; }
        
        /* Header Section */
        .header { 
            background: linear-gradient(135deg, #1e293b, #0f172a); 
            border: 1px solid #334155; border-radius: 12px; 
            padding: 1.5rem; margin-bottom: 1.5rem; 
        }
        .address { font-size: 1.75rem; font-weight: 800; color: #fff; margin-bottom: 0.5rem; }
        .permit-meta { color: #94a3b8; font-size: 0.875rem; margin-bottom: 1rem; }
        .permit-meta i { margin-right: 0.25rem; }
        .badges { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .badge { 
            padding: 0.375rem 0.875rem; border-radius: 6px; 
            font-size: 0.75rem; font-weight: 700; text-transform: uppercase; 
        }
        .badge-hot { background: #dc2626; color: white; }
        .badge-warm { background: #f59e0b; color: white; }
        .badge-cold { background: #3b82f6; color: white; }
        .badge-owner { background: #334155; color: #cbd5e1; }
        
        /* Stats Bar */
        .stats { 
            display: flex; gap: 1rem; background: #1e293b; 
            border: 1px solid #334155; border-radius: 10px; 
            padding: 1rem; margin-bottom: 1.5rem; 
        }
        .stat { flex: 1; text-align: center; }
        .stat-value { 
            font-size: 1.5rem; font-weight: 800; 
            color: #3b82f6; display: block; 
        }
        .stat-label { 
            font-size: 0.625rem; text-transform: uppercase; 
            color: #64748b; letter-spacing: 0.05em; margin-top: 0.25rem; 
        }
        
        /* Contact Cards - Most Important */
        .section { 
            background: #1e293b; border: 1px solid #334155; 
            border-radius: 10px; padding: 1.5rem; margin-bottom: 1rem; 
        }
        .section-title { 
            font-size: 1rem; font-weight: 700; color: #fff; 
            margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; 
        }
        .section-title i { color: #3b82f6; }
        
        .contacts-highlight { 
            border: 2px solid #3b82f6; 
            background: linear-gradient(135deg, #1e3a5f, #1e293b); 
        }
        
        .contact { 
            background: #0f172a; border: 1px solid #3b82f6; 
            border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; 
            border-left: 4px solid #3b82f6; 
        }
        .contact:last-child { margin-bottom: 0; }
        .contact-type { 
            font-size: 0.625rem; text-transform: uppercase; 
            color: #3b82f6; font-weight: 700; letter-spacing: 0.1em; 
            margin-bottom: 0.5rem; 
        }
        .contact-name { 
            font-size: 1.125rem; font-weight: 700; 
            color: #fff; margin-bottom: 0.25rem; 
        }
        .contact-business { 
            font-size: 0.875rem; color: #94a3b8; margin-bottom: 0.75rem; 
        }
        .contact-phone { 
            display: inline-flex; align-items: center; gap: 0.5rem; 
            background: rgba(16, 185, 129, 0.1); padding: 0.5rem 0.75rem; 
            border-radius: 6px; 
        }
        .contact-phone i { color: #10b981; }
        .contact-phone a { 
            color: #10b981; text-decoration: none; 
            font-weight: 700; font-family: 'Courier New', monospace; 
        }
        .contact-phone a:hover { color: #34d399; }
        .contact-meta { 
            font-size: 0.75rem; color: #64748b; 
            margin-top: 0.75rem; padding-top: 0.75rem; 
            border-top: 1px solid #334155; 
        }
        
        /* Info Grid - Compact 2 Column */
        .info-grid { 
            display: grid; grid-template-columns: repeat(2, 1fr); 
            gap: 0.5rem; 
        }
        .info-item { 
            display: flex; justify-content: space-between; 
            padding: 0.5rem; background: #0f172a; 
            border-radius: 6px; font-size: 0.875rem; 
        }
        .info-label { color: #94a3b8; font-weight: 500; }
        .info-value { color: #e2e8f0; font-weight: 700; text-align: right; }
        .info-value a { color: #3b82f6; text-decoration: none; }
        .info-value a:hover { text-decoration: underline; }
        .status-issued { color: #10b981; }
        .status-pending { color: #f59e0b; }
        
        /* Map */
        .map-container { 
            height: 300px; border-radius: 8px; 
            overflow: hidden; border: 1px solid #334155; 
        }
        
        /* Related Permits */
        .related { 
            display: flex; justify-content: space-between; 
            align-items: center; padding: 0.75rem; 
            background: #0f172a; border: 1px solid #334155; 
            border-radius: 6px; margin-bottom: 0.5rem; 
            text-decoration: none; color: #e2e8f0; transition: all 0.2s; 
        }
        .related:hover { 
            border-color: #3b82f6; background: #1e3a5f; 
            transform: translateX(4px); 
        }
        .related-info { flex: 1; }
        .related-title { font-weight: 700; color: #fff; margin-bottom: 0.25rem; }
        .related-meta { font-size: 0.75rem; color: #64748b; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .stats { flex-direction: column; }
            .info-grid { grid-template-columns: 1fr; }
            .container { padding: 1rem; }
            .address { font-size: 1.25rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="btn-back">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        
        <!-- Header -->
        <div class="header">
            <h1 class="address">{{ permit.address or 'No Address Available' }}</h1>
            <div class="permit-meta">
                <i class="fas fa-file-alt"></i> {{ permit.permit_no }} 
                | <i class="fas fa-tools"></i> {{ permit.job_type or 'N/A' }}
                | <i class="fas fa-calendar"></i> {{ permit.issue_date.strftime('%b %d, %Y') if permit.issue_date else 'N/A' }}
            </div>
            {% set score = permit.lead_score or 0 %}
            <div class="badges">
                {% if score >= 70 %}
                    <span class="badge badge-hot">ðŸ”¥ Hot Lead {{ score }}/100</span>
                {% elif score >= 50 %}
                    <span class="badge badge-warm">âš¡ Warm Lead {{ score }}/100</span>
                {% else %}
                    <span class="badge badge-cold">ðŸ’¡ Lead {{ score }}/100</span>
                {% endif %}
                {% if permit.current_owner_name %}
                    <span class="badge badge-owner">{{ permit.current_owner_name }}</span>
                {% endif %}
            </div>
        </div>
        
        <!-- Stats -->
        <div class="stats">
            <div class="stat">
                <span class="stat-value">{{ score }}</span>
                <span class="stat-label">Lead Score</span>
            </div>
            <div class="stat">
                <span class="stat-value">{{ (1 if permit.permittee_phone else 0) + (1 if permit.owner_phone else 0) }}</span>
                <span class="stat-label">Contacts</span>
            </div>
            {% if permit.residential_units %}
            <div class="stat">
                <span class="stat-value">{{ permit.residential_units }}</span>
                <span class="stat-label">Res Units</span>
            </div>
            {% endif %}
            {% if permit.total_units %}
            <div class="stat">
                <span class="stat-value">{{ permit.total_units }}</span>
                <span class="stat-label">Total Units</span>
            </div>
            {% endif %}
            {% if permit.assessed_total_value %}
            <div class="stat">
                <span class="stat-value">${{ (permit.assessed_total_value / 1000000)|round(1) }}M</span>
                <span class="stat-label">Value</span>
            </div>
            {% endif %}
            {% if permit.year_built %}
            <div class="stat">
                <span class="stat-value">{{ permit.year_built }}</span>
                <span class="stat-label">Built</span>
            </div>
            {% endif %}
            {% if permit.num_floors %}
            <div class="stat">
                <span class="stat-value">{{ permit.num_floors }}</span>
                <span class="stat-label">Floors</span>
            </div>
            {% endif %}
        </div>
        
        <!-- PRIMARY CONTACTS -->
        {% if permit.permittee_phone or permit.owner_phone %}
        <div class="section contacts-highlight">
            <div class="section-title">
                <i class="fas fa-phone-alt"></i> Primary Contacts
            </div>
            
            {% if permit.permittee_phone %}
            <div class="contact">
                <div class="contact-type"><i class="fas fa-hard-hat"></i> Contractor / Permittee</div>
                <div class="contact-name">
                    {% if permit.permittee_first_name or permit.permittee_last_name %}
                        {{ permit.permittee_first_name }} {{ permit.permittee_last_name }}
                    {% elif permit.applicant %}
                        {{ permit.applicant }}
                    {% else %}
                        Contractor
                    {% endif %}
                </div>
                {% if permit.permittee_business_name %}
                <div class="contact-business">{{ permit.permittee_business_name }}</div>
                {% endif %}
                <div class="contact-phone">
                    <i class="fas fa-phone"></i>
                    <a href="tel:{{ permit.permittee_phone }}">{{ permit.permittee_phone }}</a>
                </div>
                {% if permit.permittee_license_number %}
                <div class="contact-meta">
                    License: {{ permit.permittee_license_type or 'N/A' }} #{{ permit.permittee_license_number }}
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            {% if permit.owner_phone %}
            <div class="contact">
                <div class="contact-type"><i class="fas fa-user-tie"></i> Property Owner</div>
                <div class="contact-name">
                    {% if permit.owner_first_name or permit.owner_last_name %}
                        {{ permit.owner_first_name }} {{ permit.owner_last_name }}
                    {% elif permit.owner_business_name and permit.owner_business_name != 'N/A' %}
                        {{ permit.owner_business_name }}
                    {% else %}
                        Owner
                    {% endif %}
                </div>
                {% if permit.owner_business_name and permit.owner_business_name != 'N/A' %}
                <div class="contact-business">{{ permit.owner_business_name }}</div>
                {% endif %}
                <div class="contact-phone">
                    <i class="fas fa-phone"></i>
                    <a href="tel:{{ permit.owner_phone }}">{{ permit.owner_phone }}</a>
                </div>
                {% if permit.owner_house_number or permit.owner_street_name %}
                <div class="contact-meta">
                    <i class="fas fa-map-marker-alt"></i> {{ permit.owner_house_number }} {{ permit.owner_street_name }}, {{ permit.owner_city }} {{ permit.owner_state }}
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        <!-- Permit Details -->
        <div class="section">
            <div class="section-title"><i class="fas fa-file-contract"></i> Permit Details</div>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Job Type</span>
                    <span class="info-value">
                        {% if permit.job_type == 'NB' %}New Building
                        {% elif permit.job_type == 'A1' %}Alteration 1
                        {% elif permit.job_type == 'A2' %}Alteration 2
                        {% elif permit.job_type == 'A3' %}Alteration 3
                        {% elif permit.job_type == 'DM' %}Demolition
                        {% else %}{{ permit.job_type or 'N/A' }}{% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">Status</span>
                    <span class="info-value {% if permit.permit_status == 'ISSUED' %}status-issued{% elif permit.permit_status == 'PENDING' %}status-pending{% endif %}">
                        {{ permit.permit_status or 'N/A' }}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">Issue Date</span>
                    <span class="info-value">{{ permit.issue_date.strftime('%b %d, %Y') if permit.issue_date else 'N/A' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Expiration</span>
                    <span class="info-value">{{ permit.exp_date.strftime('%b %d, %Y') if permit.exp_date else 'N/A' }}</span>
                </div>
                {% if permit.filing_date %}
                <div class="info-item">
                    <span class="info-label">Filing Date</span>
                    <span class="info-value">{{ permit.filing_date.strftime('%b %d, %Y') }}</span>
                </div>
                {% endif %}
                {% if permit.work_approved %}
                <div class="info-item">
                    <span class="info-label">Work Approved</span>
                    <span class="info-value">{{ permit.work_approved.strftime('%b %d, %Y') }}</span>
                </div>
                {% endif %}
                {% if permit.proposed_job_start %}
                <div class="info-item">
                    <span class="info-label">Proposed Start</span>
                    <span class="info-value">{{ permit.proposed_job_start.strftime('%b %d, %Y') }}</span>
                </div>
                {% endif %}
                {% if permit.work_type %}
                <div class="info-item">
                    <span class="info-label">Work Type</span>
                    <span class="info-value">{{ permit.work_type }}</span>
                </div>
                {% endif %}
                {% if permit.bldg_type %}
                <div class="info-item">
                    <span class="info-label">Building Type</span>
                    <span class="info-value">{{ permit.bldg_type }}</span>
                </div>
                {% endif %}
                {% if permit.residential %}
                <div class="info-item">
                    <span class="info-label">Residential</span>
                    <span class="info-value">{{ permit.residential }}</span>
                </div>
                {% endif %}
                {% if permit.self_cert %}
                <div class="info-item">
                    <span class="info-label">Self Certified</span>
                    <span class="info-value">{{ permit.self_cert }}</span>
                </div>
                {% endif %}
                {% if permit.applicant %}
                <div class="info-item">
                    <span class="info-label">Applicant</span>
                    <span class="info-value">{{ permit.applicant }}</span>
                </div>
                {% endif %}
                {% if permit.job_number %}
                <div class="info-item">
                    <span class="info-label">Job Number</span>
                    <span class="info-value">{{ permit.job_number }}</span>
                </div>
                {% endif %}
                {% if permit.job_doc_number %}
                <div class="info-item">
                    <span class="info-label">Doc Number</span>
                    <span class="info-value">{{ permit.job_doc_number }}</span>
                </div>
                {% endif %}
            </div>
            {% if permit.work_description %}
            <div style="margin-top: 1rem; padding: 1rem; background: #0f172a; border-radius: 6px; border-left: 3px solid #3b82f6;">
                <div style="font-size: 0.75rem; text-transform: uppercase; color: #3b82f6; font-weight: 700; margin-bottom: 0.5rem;">Work Description</div>
                <div style="color: #cbd5e1; font-size: 0.875rem; line-height: 1.6;">{{ permit.work_description }}</div>
            </div>
            {% endif %}
        </div>
        
        <!-- Property Info -->
        <div class="section">
            <div class="section-title"><i class="fas fa-building"></i> Property Information</div>
            <div class="info-grid">
                {% if permit.bbl %}
                <div class="info-item">
                    <span class="info-label">BBL</span>
                    <span class="info-value">{{ permit.bbl }}</span>
                </div>
                {% endif %}
                {% if permit.bin %}
                <div class="info-item">
                    <span class="info-label">BIN</span>
                    <span class="info-value">{{ permit.bin }}</span>
                </div>
                {% endif %}
                {% if permit.borough %}
                <div class="info-item">
                    <span class="info-label">Borough</span>
                    <span class="info-value">{{ permit.borough }}</span>
                </div>
                {% endif %}
                {% if permit.block %}
                <div class="info-item">
                    <span class="info-label">Block</span>
                    <span class="info-value">{{ permit.block }}</span>
                </div>
                {% endif %}
                {% if permit.lot %}
                <div class="info-item">
                    <span class="info-label">Lot</span>
                    <span class="info-value">{{ permit.lot }}</span>
                </div>
                {% endif %}
                {% if permit.zip_code %}
                <div class="info-item">
                    <span class="info-label">Zip Code</span>
                    <span class="info-value">{{ permit.zip_code }}</span>
                </div>
                {% endif %}
                {% if permit.community_board %}
                <div class="info-item">
                    <span class="info-label">Community Board</span>
                    <span class="info-value">{{ permit.community_board }}</span>
                </div>
                {% endif %}
                {% if permit.council_district %}
                <div class="info-item">
                    <span class="info-label">Council District</span>
                    <span class="info-value">{{ permit.council_district }}</span>
                </div>
                {% endif %}
                {% if permit.nta_name %}
                <div class="info-item">
                    <span class="info-label">Neighborhood</span>
                    <span class="info-value">{{ permit.nta_name }}</span>
                </div>
                {% endif %}
                {% if permit.year_built %}
                <div class="info-item">
                    <span class="info-label">Year Built</span>
                    <span class="info-value">{{ permit.year_built }}</span>
                </div>
                {% endif %}
                {% if permit.year_altered %}
                <div class="info-item">
                    <span class="info-label">Last Altered</span>
                    <span class="info-value">
                        {{ permit.year_altered }}
                        {% if (2025 - permit.year_altered) <= 5 %}<span style="color: #f59e0b;">ðŸ”¥</span>{% endif %}
                    </span>
                </div>
                {% endif %}
                {% if permit.residential_units %}
                <div class="info-item">
                    <span class="info-label">Residential Units</span>
                    <span class="info-value">{{ permit.residential_units }}</span>
                </div>
                {% endif %}
                {% if permit.total_dwelling_units %}
                <div class="info-item">
                    <span class="info-label">Dwelling Units</span>
                    <span class="info-value">{{ permit.total_dwelling_units }}</span>
                </div>
                {% endif %}
                {% if permit.dwelling_units_occupied %}
                <div class="info-item">
                    <span class="info-label">Occupied Units</span>
                    <span class="info-value">{{ permit.dwelling_units_occupied }}</span>
                </div>
                {% endif %}
                {% if permit.num_floors %}
                <div class="info-item">
                    <span class="info-label">Floors</span>
                    <span class="info-value">{{ permit.num_floors }}</span>
                </div>
                {% endif %}
                {% if permit.stories %}
                <div class="info-item">
                    <span class="info-label">Stories</span>
                    <span class="info-value">{{ permit.stories }}</span>
                </div>
                {% endif %}
                {% if permit.building_sqft %}
                <div class="info-item">
                    <span class="info-label">Building SF</span>
                    <span class="info-value">{{ "{:,}".format(permit.building_sqft|int) }}</span>
                </div>
                {% endif %}
                {% if permit.lot_sqft %}
                <div class="info-item">
                    <span class="info-label">Lot SF</span>
                    <span class="info-value">{{ "{:,}".format(permit.lot_sqft|int) }}</span>
                </div>
                {% endif %}
                {% if permit.building_class %}
                <div class="info-item">
                    <span class="info-label">Building Class</span>
                    <span class="info-value">{{ permit.building_class }}</span>
                </div>
                {% endif %}
                {% if permit.land_use %}
                <div class="info-item">
                    <span class="info-label">Land Use</span>
                    <span class="info-value">{{ permit.land_use }}</span>
                </div>
                {% endif %}
                {% if permit.use_type %}
                <div class="info-item">
                    <span class="info-label">Use Type</span>
                    <span class="info-value">{{ permit.use_type }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Financial Data -->
        {% if permit.assessed_total_value or permit.purchase_price %}
        <div class="section">
            <div class="section-title"><i class="fas fa-dollar-sign"></i> Financial Information</div>
            <div class="info-grid">
                {% if permit.assessed_total_value %}
                <div class="info-item">
                    <span class="info-label">Assessed Value</span>
                    <span class="info-value" style="color: #10b981;">${{ "{:,}".format(permit.assessed_total_value|int) }}</span>
                </div>
                {% endif %}
                {% if permit.assessed_land_value %}
                <div class="info-item">
                    <span class="info-label">Land Value</span>
                    <span class="info-value">${{ "{:,}".format(permit.assessed_land_value|int) }}</span>
                </div>
                {% endif %}
                {% if permit.estimated_value %}
                <div class="info-item">
                    <span class="info-label">Estimated Value</span>
                    <span class="info-value" style="color: #10b981;">${{ "{:,}".format(permit.estimated_value|int) }}</span>
                </div>
                {% endif %}
                {% if permit.purchase_date %}
                <div class="info-item">
                    <span class="info-label">Purchase Date</span>
                    <span class="info-value">{{ permit.purchase_date.strftime('%b %d, %Y') }}</span>
                </div>
                {% endif %}
                {% if permit.purchase_price %}
                <div class="info-item">
                    <span class="info-label">Purchase Price</span>
                    <span class="info-value">${{ "{:,}".format(permit.purchase_price|int) }}</span>
                </div>
                {% endif %}
                {% if permit.sale_price %}
                <div class="info-item">
                    <span class="info-label">Sale Price</span>
                    <span class="info-value">${{ "{:,}".format(permit.sale_price|int) }}</span>
                </div>
                {% endif %}
                {% if permit.sale_date %}
                <div class="info-item">
                    <span class="info-label">Sale Date</span>
                    <span class="info-value">{{ permit.sale_date.strftime('%b %d, %Y') }}</span>
                </div>
                {% endif %}
                {% if permit.mortgage_amount %}
                <div class="info-item">
                    <span class="info-label">Mortgage</span>
                    <span class="info-value">${{ "{:,}".format(permit.mortgage_amount|int) }}</span>
                </div>
                {% endif %}
                {% if permit.mortgage_date %}
                <div class="info-item">
                    <span class="info-label">Mortgage Date</span>
                    <span class="info-value">{{ permit.mortgage_date.strftime('%b %d, %Y') }}</span>
                </div>
                {% endif %}
                {% if permit.mortgage_lender_primary %}
                <div class="info-item">
                    <span class="info-label">Lender</span>
                    <span class="info-value">{{ permit.mortgage_lender_primary }}</span>
                </div>
                {% endif %}
                {% if permit.is_cash_purchase %}
                <div class="info-item">
                    <span class="info-label">Cash Purchase</span>
                    <span class="info-value" style="color: #f59e0b;">Yes ðŸ’°</span>
                </div>
                {% endif %}
                {% if permit.financing_ratio %}
                <div class="info-item">
                    <span class="info-label">LTV Ratio</span>
                    <span class="info-value">{{ (permit.financing_ratio * 100)|round(1) }}%</span>
                </div>
                {% endif %}
                {% if permit.days_since_sale %}
                <div class="info-item">
                    <span class="info-label">Days Since Sale</span>
                    <span class="info-value">{{ permit.days_since_sale }} days</span>
                </div>
                {% endif %}
                {% if permit.estimated_equity %}
                <div class="info-item">
                    <span class="info-label">Estimated Equity</span>
                    <span class="info-value" style="color: #10b981;">${{ "{:,}".format(permit.estimated_equity|int) }}</span>
                </div>
                {% endif %}
                {% if permit.estimated_annual_rent %}
                <div class="info-item">
                    <span class="info-label">Est. Annual Rent</span>
                    <span class="info-value">${{ "{:,}".format(permit.estimated_annual_rent|int) }}</span>
                </div>
                {% endif %}
                {% if permit.estimated_rent_per_unit %}
                <div class="info-item">
                    <span class="info-label">Est. Rent/Unit</span>
                    <span class="info-value">${{ "{:,}".format(permit.estimated_rent_per_unit|int) }}/mo</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- HPD & Compliance -->
        {% if permit.hpd_open_violations or permit.hpd_total_violations or permit.hpd_open_complaints %}
        <div class="section">
            <div class="section-title"><i class="fas fa-exclamation-triangle"></i> HPD Violations & Complaints</div>
            <div class="info-grid">
                {% if permit.hpd_open_violations %}
                <div class="info-item">
                    <span class="info-label">Open Violations</span>
                    <span class="info-value" style="color: {% if permit.hpd_open_violations > 5 %}#ef4444{% else %}#f59e0b{% endif %};">
                        {{ permit.hpd_open_violations }}
                    </span>
                </div>
                {% endif %}
                {% if permit.hpd_total_violations %}
                <div class="info-item">
                    <span class="info-label">Total Violations</span>
                    <span class="info-value">{{ permit.hpd_total_violations }}</span>
                </div>
                {% endif %}
                {% if permit.hpd_open_complaints %}
                <div class="info-item">
                    <span class="info-label">Open Complaints</span>
                    <span class="info-value" style="color: {% if permit.hpd_open_complaints > 3 %}#ef4444{% else %}#f59e0b{% endif %};">
                        {{ permit.hpd_open_complaints }}
                    </span>
                </div>
                {% endif %}
                {% if permit.hpd_total_complaints %}
                <div class="info-item">
                    <span class="info-label">Total Complaints</span>
                    <span class="info-value">{{ permit.hpd_total_complaints }}</span>
                </div>
                {% endif %}
                {% if permit.hpd_registration_id %}
                <div class="info-item">
                    <span class="info-label">HPD Reg ID</span>
                    <span class="info-value">{{ permit.hpd_registration_id }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- ACRIS Transaction History -->
        {% if permit.acris_total_transactions or permit.acris_deed_count %}
        <div class="section">
            <div class="section-title"><i class="fas fa-file-invoice-dollar"></i> Transaction History (ACRIS)</div>
            <div class="info-grid">
                {% if permit.acris_total_transactions %}
                <div class="info-item">
                    <span class="info-label">Total Transactions</span>
                    <span class="info-value">{{ permit.acris_total_transactions }}</span>
                </div>
                {% endif %}
                {% if permit.acris_deed_count %}
                <div class="info-item">
                    <span class="info-label">Deed Transfers</span>
                    <span class="info-value">{{ permit.acris_deed_count }}</span>
                </div>
                {% endif %}
                {% if permit.acris_mortgage_count %}
                <div class="info-item">
                    <span class="info-label">Mortgages</span>
                    <span class="info-value">{{ permit.acris_mortgage_count }}</span>
                </div>
                {% endif %}
                {% if permit.acris_satisfaction_count %}
                <div class="info-item">
                    <span class="info-label">Satisfactions</span>
                    <span class="info-value">{{ permit.acris_satisfaction_count }}</span>
                </div>
                {% endif %}
                {% if permit.sale_buyer_primary %}
                <div class="info-item">
                    <span class="info-label">Current Buyer</span>
                    <span class="info-value">{{ permit.sale_buyer_primary }}</span>
                </div>
                {% endif %}
                {% if permit.sale_seller_primary %}
                <div class="info-item">
                    <span class="info-label">Previous Seller</span>
                    <span class="info-value">{{ permit.sale_seller_primary }}</span>
                </div>
                {% endif %}
                {% if permit.sale_percent_transferred %}
                <div class="info-item">
                    <span class="info-label">% Transferred</span>
                    <span class="info-value">{{ permit.sale_percent_transferred }}%</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Owner Information -->
        {% if permit.owner_business_name or permit.current_owner_name %}
        <div class="section">
            <div class="section-title"><i class="fas fa-user-tie"></i> Owner Details</div>
            <div class="info-grid">
                {% if permit.current_owner_name %}
                <div class="info-item">
                    <span class="info-label">Current Owner</span>
                    <span class="info-value">{{ permit.current_owner_name }}</span>
                </div>
                {% endif %}
                {% if permit.owner_name_rpad %}
                <div class="info-item">
                    <span class="info-label">Owner (RPAD)</span>
                    <span class="info-value">{{ permit.owner_name_rpad }}</span>
                </div>
                {% endif %}
                {% if permit.owner_name_hpd %}
                <div class="info-item">
                    <span class="info-label">Owner (HPD)</span>
                    <span class="info-value">{{ permit.owner_name_hpd }}</span>
                </div>
                {% endif %}
                {% if permit.owner_business_type %}
                <div class="info-item">
                    <span class="info-label">Business Type</span>
                    <span class="info-value">{{ permit.owner_business_type }}</span>
                </div>
                {% endif %}
                {% if permit.non_profit %}
                <div class="info-item">
                    <span class="info-label">Non-Profit</span>
                    <span class="info-value">{{ permit.non_profit }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Additional Contacts -->
        {% if permit.superintendent_business_name or permit.site_safety_mgr_business_name %}
        <div class="section">
            <div class="section-title"><i class="fas fa-users"></i> Additional Contacts</div>
            <div class="info-grid">
                {% if permit.superintendent_business_name or permit.superintendent_name %}
                <div class="info-item">
                    <span class="info-label">Superintendent</span>
                    <span class="info-value">{{ permit.superintendent_name or permit.superintendent_business_name }}</span>
                </div>
                {% endif %}
                {% if permit.site_safety_mgr_business_name or permit.site_safety_mgr_first_name %}
                <div class="info-item">
                    <span class="info-label">Safety Manager</span>
                    <span class="info-value">
                        {% if permit.site_safety_mgr_first_name or permit.site_safety_mgr_last_name %}
                            {{ permit.site_safety_mgr_first_name }} {{ permit.site_safety_mgr_last_name }}
                        {% else %}
                            {{ permit.site_safety_mgr_business_name }}
                        {% endif %}
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Map -->
        <div class="section">
            <div class="section-title"><i class="fas fa-map-marked-alt"></i> Location</div>
            <div id="map" class="map-container"></div>
        </div>
        
        <!-- Related Permits -->
        {% if related_permits %}
        <div class="section">
            <div class="section-title"><i class="fas fa-sitemap"></i> Related Permits ({{ related_permits|length }})</div>
            {% for rp in related_permits %}
            <a href="/permit/{{ rp.id }}" class="related">
                <div class="related-info">
                    <div class="related-title">{{ rp.permit_no }} - {{ rp.job_type or 'N/A' }}</div>
                    <div class="related-meta">
                        {{ rp.issue_date.strftime('%b %d, %Y') if rp.issue_date else 'No date' }} | {{ rp.contact_count or 0 }} contacts
                    </div>
                </div>
                <i class="fas fa-arrow-right"></i>
            </a>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            {% if permit.latitude and permit.longitude %}
            const map = L.map('map').setView([{{ permit.latitude }}, {{ permit.longitude }}], 16);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            
            const marker = L.marker([{{ permit.latitude }}, {{ permit.longitude }}]).addTo(map);
            marker.bindPopup('<b>{{ permit.address }}</b><br>{{ permit.borough or "New York" }}').openPopup();
            {% else %}
            document.getElementById('map').innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #0f172a;">
                    <i class="fas fa-map-marker-alt" style="font-size: 3rem; color: #475569; margin-bottom: 1rem;"></i>
                    <p style="color: #e2e8f0; font-size: 1.125rem; margin: 0; font-weight: 600;">
                        {{ permit.address }}
                    </p>
                    <small style="color: #64748b; margin-top: 1rem;">
                        <i class="fas fa-info-circle"></i> Coordinates not available
                    </small>
                </div>
            `;
            {% endif %}
        });
    </script>
</body>
</html>
